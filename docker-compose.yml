# ========================================
# FILENAME: aivlebigproject/docker-compose.yml
# ì—­í•  : 
# ========================================

version: '3.8' # ìµœì‹  ë²„ì „ ëª…ì‹œ
services:
  my-kafka:
    image: confluentinc/cp-kafka:latest
    container_name: my-kafka
    ports:
      - "9092:9092"   # í´ë¼ì´ì–¸íŠ¸ í†µì‹ ìš©
    environment:
      # KRaft ëª¨ë“œ í•„ìˆ˜ ì„¤ì •
      CLUSTER_ID: "kraft-cluster-01"
      KAFKA_KRAFT_MODE: "true"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: "1"
      # ğŸ‘‡ ì„œë¹„ìŠ¤ ì´ë¦„ì— ë§ê²Œ 'my-kafka'ë¡œ ìˆ˜ì •
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@my-kafka:9093"

      # ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      # ì»¨í…Œì´ë„ˆ ê°„ í†µì‹  ì‹œì—ëŠ” ì„œë¹„ìŠ¤ ì´ë¦„(my-kafka)ì„, ì™¸ë¶€ì—ì„œëŠ” localhostë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      # Java/Python ì„œë¹„ìŠ¤ê°€ Docker ë‚´ë¶€ì—ì„œ í†µì‹ í•˜ë¯€ë¡œ kafka:9092ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
      # ğŸ‘‡ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë“¤ì´ ì ‘ì†í•  ì£¼ì†Œë¥¼ 'my-kafka'ë¡œ ìˆ˜ì •
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://my-kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # ê¸°íƒ€ í•„ìˆ˜ ì„¤ì •
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
    volumes:
      - kafka-data:/var/lib/kafka/data

    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --list --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Gateway ì„œë¹„ìŠ¤ ì¶”ê°€
  gateway:
    image: adoptopenjdk/maven-openjdk11:latest
    command: mvn spring-boot:run
    working_dir: /usr/src
    depends_on:
      # - servicecontext # ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ëœ í›„ì— gatewayê°€ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
      - funeralcontext 
      # - usercontext
      # - memorialcontext
      # - dataanalysis
      - funeralcontext-ai
      # - memorialcontext-ai
      # - dataanalysis-ai
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    ports:
      - "8080:8080" # ì™¸ë¶€ 8080 í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆ 8080 í¬íŠ¸ë¡œ ì—°ê²°
    volumes:
      - ./gateway:/usr/src # ë¡œì»¬ gateway í´ë”ë¥¼ ì»¨í…Œì´ë„ˆì™€ ì—°ê²°
      - ./maven-repo:/root/.m2

  servicecontext:
    # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
    image: adoptopenjdk/maven-openjdk11:latest
    command: mvn spring-boot:run
    working_dir: /usr/src
    depends_on:
      my-kafka:
        condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    env_file: # <-- env : OpenAI API, Azureblob, AzuremySQL, ì˜ìƒ-ìŒì•…API
      - .env          
    volumes:
      - ./servicecontext:/usr/src
      - ./maven-repo:/root/.m2

  funeralcontext:
    # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
    image: adoptopenjdk/maven-openjdk11:latest
    command: mvn spring-boot:run
    working_dir: /usr/src
    depends_on:
      my-kafka:
        condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    env_file: # <-- env : OpenAI API, Azureblob, AzuremySQL, ì˜ìƒ-ìŒì•…API
      - .env          
    volumes:
      - ./funeralcontext:/usr/src
      - ./maven-repo:/root/.m2

  # usercontext:
  #   # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
  #   image: adoptopenjdk/maven-openjdk11:latest
  #   command: mvn spring-boot:run
  #   working_dir: /usr/src
  #   depends_on:
  #     my-kafka:
  #       condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker   
  #   volumes:
  #     - ./usercontext:/usr/src
  #     - ./maven-repo:/root/.m2

  # memorialcontext:
  #   # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
  #   image: adoptopenjdk/maven-openjdk11:latest
  #   command: mvn spring-boot:run
  #   working_dir: /usr/src
  #   depends_on:
  #     my-kafka:
  #       condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker
  #   env_file: # <-- env : OpenAI API, Azureblob, AzuremySQL, ì˜ìƒ-ìŒì•…API
  #     - .env          
  #   volumes:
  #     - ./memorialcontext:/usr/src
  #     - ./maven-repo:/root/.m2

  # dataanalysis:
  #   # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
  #   image: adoptopenjdk/maven-openjdk11:latest
  #   command: mvn spring-boot:run
  #   working_dir: /usr/src
  #   depends_on:
  #     my-kafka:
  #       condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=docker   
  #   volumes:
  #     - ./dataanalysis:/usr/src
  #     - ./maven-repo:/root/.m2

  funeralcontext-ai:
    # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
    image: python:3.9-slim # 1. Python ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì‚¬ìš©
    command: sh -c "pip install -r requirements.txt && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    working_dir: /app
    depends_on:
      my-kafka:
        condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
    env_file: # <-- env : OpenAI API, Azureblob, AzuremySQL, ì˜ìƒ-ìŒì•…API
      - .env          
    volumes:
      - ./funeralcontext-ai:/app

  # memorialcontext-ai:
  #   # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
  #   image: python:3.9-slim
  #   command: sh -c "pip install -r requirements.txt && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
  #   working_dir: /app
  #   depends_on:
  #     my-kafka:
  #       condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  #   env_file: # <-- env : OpenAI API, Azureblob, AzuremySQL, ì˜ìƒ-ìŒì•…API
  #     - .env          
  #   volumes:
  #     - ./memorialcontext-ai:/app

  # dataanalysis-ai:
  #   # build: ... ë¥¼ ì‚­ì œí•˜ê³  ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³€ê²½
  #   image: python:3.9-slim # 1. Python ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì‚¬ìš©
  #   command: sh -c "pip install -r requirements.txt && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
  #   working_dir: /app
  #   depends_on:
  #     my-kafka:
  #       condition: service_healthy # kafka ì„œë¹„ìŠ¤ê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
  #   env_file: # <-- env : OpenAI API, Azureblob, AzuremySQL, ì˜ìƒ-ìŒì•…API
  #     - .env          
  #   volumes:
  #     - ./dataanalysis-ai:/app

volumes:
  kafka-data:
  maven-repo: # Maven ë¼ì´ë¸ŒëŸ¬ë¦¬ ìºì‹œë¥¼ ìœ„í•œ ë³¼ë¥¨ ì¶”ê°€